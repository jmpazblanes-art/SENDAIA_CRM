{
    "name":  "Agente Secretario Telegram (SendaIA CRM) - FIXED PROD",
    "nodes":  [
                  {
                      "parameters":  {
                                         "updates":  [
                                                         "message"
                                                     ],
                                         "additionalFields":  {

                                                              }
                                     },
                      "type":  "n8n-nodes-base.telegramTrigger",
                      "typeVersion":  1.1,
                      "position":  [
                                       -15936,
                                       3968
                                   ],
                      "id":  "trigger-001",
                      "name":  "Telegram Trigger",
                      "credentials":  {
                                          "telegramApi":  {
                                                              "id":  "Wn2dsNr2SKUiwoAH",
                                                              "name":  "Sendia secretario"
                                                          }
                                      }
                  },
                  {
                      "parameters":  {
                                         "rules":  {
                                                       "values":  [
                                                                      {
                                                                          "conditions":  {
                                                                                             "options":  {
                                                                                                             "caseSensitive":  true
                                                                                                         },
                                                                                             "conditions":  [
                                                                                                                {
                                                                                                                    "leftValue":  "={{ $json.message.voice }}",
                                                                                                                    "operator":  {
                                                                                                                                     "type":  "string",
                                                                                                                                     "operation":  "notEmpty",
                                                                                                                                     "singleValue":  true
                                                                                                                                 }
                                                                                                                }
                                                                                                            ]
                                                                                         },
                                                                          "renameOutput":  true,
                                                                          "outputKey":  "audio"
                                                                      },
                                                                      {
                                                                          "conditions":  {
                                                                                             "options":  {
                                                                                                             "caseSensitive":  true
                                                                                                         },
                                                                                             "conditions":  [
                                                                                                                {
                                                                                                                    "leftValue":  "={{ $json.message.voice }}",
                                                                                                                    "operator":  {
                                                                                                                                     "type":  "string",
                                                                                                                                     "operation":  "isEmpty",
                                                                                                                                     "singleValue":  true
                                                                                                                                 }
                                                                                                                }
                                                                                                            ]
                                                                                         },
                                                                          "renameOutput":  true,
                                                                          "outputKey":  "text"
                                                                      }
                                                                  ]
                                                   },
                                         "options":  {

                                                     }
                                     },
                      "type":  "n8n-nodes-base.switch",
                      "typeVersion":  3.2,
                      "position":  [
                                       -15712,
                                       3808
                                   ],
                      "id":  "switch-input-001",
                      "name":  "Detect Audio/Text"
                  },
                  {
                      "parameters":  {
                                         "operation":  "get",
                                         "resource":  "file",
                                         "chatId":  "={{ $node[\"Telegram Trigger\"].json.message.chat.id.toString() }}",
                                         "fileId":  "={{ $node[\"Telegram Trigger\"].json.message.voice.file_id }}"
                                     },
                      "type":  "n8n-nodes-base.telegram",
                      "typeVersion":  1.2,
                      "position":  [
                                       -15520,
                                       3744
                                   ],
                      "id":  "get-audio-001",
                      "name":  "Get Audio File",
                      "credentials":  {
                                          "telegramApi":  {
                                                              "id":  "Wn2dsNr2SKUiwoAH",
                                                              "name":  "Sendia secretario"
                                                          }
                                      }
                  },
                  {
                      "parameters":  {
                                         "operation":  "toBinary",
                                         "sourceProperty":  "data"
                                     },
                      "type":  "n8n-nodes-base.convertToFile",
                      "typeVersion":  1.1,
                      "position":  [
                                       -15328,
                                       3744
                                   ],
                      "id":  "convert-audio-001",
                      "name":  "File to Binary"
                  },
                  {
                      "parameters":  {
                                         "operation":  "transcribe",
                                         "resource":  "audio"
                                     },
                      "type":  "@n8n/n8n-nodes-langchain.openAi",
                      "typeVersion":  2.1,
                      "position":  [
                                       -15136,
                                       3744
                                   ],
                      "id":  "transcribe-001",
                      "name":  "Transcription",
                      "credentials":  {
                                          "openAiApi":  {
                                                            "id":  "EjD1xFLPo07r54tp",
                                                            "name":  "OpenAi account"
                                                        }
                                      }
                  },
                  {
                      "parameters":  {
                                         "assignments":  {
                                                             "assignments":  [
                                                                                 {
                                                                                     "id":  "a1",
                                                                                     "name":  "text",
                                                                                     "value":  "={{ $node[\"Transcription\"]?.json?.text || $node[\"Telegram Trigger\"].json.message.text || $node[\"Telegram Trigger\"].json.message.caption || \u0027\u0027 }}",
                                                                                     "type":  "string"
                                                                                 },
                                                                                 {
                                                                                     "id":  "a2",
                                                                                     "name":  "chatId",
                                                                                     "value":  "={{ $node[\"Telegram Trigger\"].json.message.chat.id }}",
                                                                                     "type":  "string"
                                                                                 },
                                                                                 {
                                                                                     "id":  "a3",
                                                                                     "name":  "fromName",
                                                                                     "value":  "={{ $node[\"Telegram Trigger\"].json.message.from.first_name || \u0027\u0027 }}",
                                                                                     "type":  "string"
                                                                                 }
                                                                             ]
                                                         },
                                         "options":  {

                                                     }
                                     },
                      "type":  "n8n-nodes-base.set",
                      "typeVersion":  3.4,
                      "position":  [
                                       -14880,
                                       3968
                                   ],
                      "id":  "map-input-001",
                      "name":  "Map Telegram Input"
                  },
                  {
                      "parameters":  {
                                         "promptType":  "define",
                                         "text":  "=Mensaje del usuario: {{ $json.text }}",
                                         "options":  {
                                                         "systemMessage":  "Eres el asistente operativo de SendaIA. Tu trabajo es gestionar CRM en Supabase y agendar en Google Calendar.\n\nDEVUELVE SIEMPRE JSON VALIDO con esta estructura:\n{\n  \"intent\": \"create_lead|create_appointment|add_note|list_leads|unknown\",\n  \"data\": {\n    \"full_name\": \"\",\n    \"phone\": \"\",\n    \"email\": \"\",\n    \"company_name\": \"\",\n    \"title\": \"\",\n    \"type\": \"DEMO|DIAGNOSTICO|ONBOARDING\",\n    \"start_time\": \"ISO\",\n    \"end_time\": \"ISO\",\n    \"content\": \"\"\n  },\n  \"missing_fields\": [],\n  \"reply\": \"\"\n}\n\nREGLAS:\n- No inventes telÃ©fonos/emails/fechas.\n- Si faltan datos, rellena missing_fields y pregunta en reply.\n- create_lead requiere: full_name, phone (o email), email (o phone).\n- create_appointment requiere: full_name, phone o email, title, type, start_time, end_time.\n- add_note requiere: content.\n- list_leads no requiere datos."
                                                     }
                                     },
                      "type":  "@n8n/n8n-nodes-langchain.agent",
                      "typeVersion":  1.7,
                      "position":  [
                                       -14624,
                                       3968
                                   ],
                      "id":  "agent-001",
                      "name":  "AI Secretary Agent"
                  },
                  {
                      "parameters":  {
                                         "jsCode":  "function safeParse(x){\n  if (typeof x === \u0027object\u0027) return x;\n  try { return JSON.parse(x); } catch(e) { return null; }\n}\n\nconst raw = $json.output;\nconst parsed = safeParse(raw);\n\nif (!parsed || !parsed.intent) {\n  return [{\n    intent: \u0027unknown\u0027,\n    data: {},\n    missing_fields: [],\n    reply: \u0027No he podido interpretar la peticiÃ³n. Dime si quieres: crear lead, aÃ±adir nota, listar leads o crear cita.\u0027\n  }];\n}\n\nparsed.data = parsed.data || {};\nparsed.missing_fields = parsed.missing_fields || [];\nparsed.reply = parsed.reply || \u0027\u0027;\n\nreturn [parsed];"
                                     },
                      "type":  "n8n-nodes-base.code",
                      "typeVersion":  2,
                      "position":  [
                                       -14368,
                                       3968
                                   ],
                      "id":  "normalize-001",
                      "name":  "Normalize Agent JSON"
                  },
                  {
                      "parameters":  {
                                         "rules":  {
                                                       "values":  [
                                                                      {
                                                                          "conditions":  {
                                                                                             "options":  {
                                                                                                             "caseSensitive":  true
                                                                                                         },
                                                                                             "conditions":  [
                                                                                                                {
                                                                                                                    "leftValue":  "={{ $json.intent }}",
                                                                                                                    "rightValue":  "create_lead",
                                                                                                                    "operator":  {
                                                                                                                                     "type":  "string",
                                                                                                                                     "operation":  "equal"
                                                                                                                                 }
                                                                                                                }
                                                                                                            ]
                                                                                         },
                                                                          "renameOutput":  true,
                                                                          "outputKey":  "create_lead"
                                                                      },
                                                                      {
                                                                          "conditions":  {
                                                                                             "options":  {
                                                                                                             "caseSensitive":  true
                                                                                                         },
                                                                                             "conditions":  [
                                                                                                                {
                                                                                                                    "leftValue":  "={{ $json.intent }}",
                                                                                                                    "rightValue":  "create_appointment",
                                                                                                                    "operator":  {
                                                                                                                                     "type":  "string",
                                                                                                                                     "operation":  "equal"
                                                                                                                                 }
                                                                                                                }
                                                                                                            ]
                                                                                         },
                                                                          "renameOutput":  true,
                                                                          "outputKey":  "create_appointment"
                                                                      },
                                                                      {
                                                                          "conditions":  {
                                                                                             "options":  {
                                                                                                             "caseSensitive":  true
                                                                                                         },
                                                                                             "conditions":  [
                                                                                                                {
                                                                                                                    "leftValue":  "={{ $json.intent }}",
                                                                                                                    "rightValue":  "add_note",
                                                                                                                    "operator":  {
                                                                                                                                     "type":  "string",
                                                                                                                                     "operation":  "equal"
                                                                                                                                 }
                                                                                                                }
                                                                                                            ]
                                                                                         },
                                                                          "renameOutput":  true,
                                                                          "outputKey":  "add_note"
                                                                      },
                                                                      {
                                                                          "conditions":  {
                                                                                             "options":  {
                                                                                                             "caseSensitive":  true
                                                                                                         },
                                                                                             "conditions":  [
                                                                                                                {
                                                                                                                    "leftValue":  "={{ $json.intent }}",
                                                                                                                    "rightValue":  "list_leads",
                                                                                                                    "operator":  {
                                                                                                                                     "type":  "string",
                                                                                                                                     "operation":  "equal"
                                                                                                                                 }
                                                                                                                }
                                                                                                            ]
                                                                                         },
                                                                          "renameOutput":  true,
                                                                          "outputKey":  "list_leads"
                                                                      }
                                                                  ]
                                                   },
                                         "options":  {
                                                         "fallbackOutput":  4
                                                     }
                                     },
                      "type":  "n8n-nodes-base.switch",
                      "typeVersion":  3.2,
                      "position":  [
                                       -14128,
                                       3968
                                   ],
                      "id":  "router-001",
                      "name":  "Route Intent"
                  },
                  {
                      "parameters":  {
                                         "jsCode":  "const d = $json.data || {};\nconst phone = (d.phone || \u0027\u0027).trim();\nconst email = (d.email || \u0027\u0027).trim();\n\nif (!phone \u0026\u0026 !email) {\n  return [{ lookupUrl: null, phone, email }];\n}\n\nif (phone) {\n  return [{ lookupUrl: `${$env.SUPABASE_URL}/rest/v1/clients?select=id,first_name,last_name,email,phone\u0026phone=eq.${encodeURIComponent(phone)}\u0026limit=1`, phone, email }];\n}\n\nreturn [{ lookupUrl: `${$env.SUPABASE_URL}/rest/v1/clients?select=id,first_name,last_name,email,phone\u0026email=eq.${encodeURIComponent(email)}\u0026limit=1`, phone, email }];"
                                     },
                      "type":  "n8n-nodes-base.code",
                      "typeVersion":  2,
                      "position":  [
                                       -13856,
                                       3744
                                   ],
                      "id":  "lookup-lead-001",
                      "name":  "Build Client Lookup (Lead)"
                  },
                  {
                      "parameters":  {
                                         "url":  "={{ $json.lookupUrl }}",
                                         "sendHeaders":  true,
                                         "headerParameters":  {
                                                                  "parameters":  [
                                                                                     {
                                                                                         "name":  "apikey",
                                                                                         "value":  "={{ $env.SUPABASE_SERVICE_ROLE_KEY }}"
                                                                                     },
                                                                                     {
                                                                                         "name":  "Authorization",
                                                                                         "value":  "={{ `Bearer ${$env.SUPABASE_SERVICE_ROLE_KEY}` }}"
                                                                                     },
                                                                                     {
                                                                                         "name":  "Accept",
                                                                                         "value":  "application/json"
                                                                                     }
                                                                                 ]
                                                              },
                                         "options":  {

                                                     }
                                     },
                      "type":  "n8n-nodes-base.httpRequest",
                      "typeVersion":  4.2,
                      "position":  [
                                       -13600,
                                       3744
                                   ],
                      "id":  "supa-get-lead-001",
                      "name":  "SUPA - Get Client (Lead)"
                  },
                  {
                      "parameters":  {
                                         "conditions":  {
                                                            "boolean":  [
                                                                            {
                                                                                "value1":  "={{ Array.isArray($json) \u0026\u0026 $json.length \u003e 0 }}",
                                                                                "value2":  true
                                                                            }
                                                                        ]
                                                        },
                                         "options":  {

                                                     }
                                     },
                      "type":  "n8n-nodes-base.if",
                      "typeVersion":  2,
                      "position":  [
                                       -13360,
                                       3744
                                   ],
                      "id":  "if-lead-001",
                      "name":  "IF Client Exists (Lead)"
                  },
                  {
                      "parameters":  {
                                         "method":  "POST",
                                         "url":  "={{ $env.SUPABASE_URL }}/rest/v1/clients",
                                         "sendHeaders":  true,
                                         "headerParameters":  {
                                                                  "parameters":  [
                                                                                     {
                                                                                         "name":  "apikey",
                                                                                         "value":  "={{ $env.SUPABASE_SERVICE_ROLE_KEY }}"
                                                                                     },
                                                                                     {
                                                                                         "name":  "Authorization",
                                                                                         "value":  "={{ `Bearer ${$env.SUPABASE_SERVICE_ROLE_KEY}` }}"
                                                                                     },
                                                                                     {
                                                                                         "name":  "Content-Type",
                                                                                         "value":  "application/json"
                                                                                     },
                                                                                     {
                                                                                         "name":  "Prefer",
                                                                                         "value":  "return=representation"
                                                                                     }
                                                                                 ]
                                                              },
                                         "sendBody":  true,
                                         "bodyParameters":  {
                                                                "parameters":  [
                                                                                   {
                                                                                       "name":  "first_name",
                                                                                       "value":  "={{ ($node[\"Normalize Agent JSON\"].json.data.full_name || \u0027\u0027).split(\u0027 \u0027)[0] }}"
                                                                                   },
                                                                                   {
                                                                                       "name":  "last_name",
                                                                                       "value":  "={{ ($node[\"Normalize Agent JSON\"].json.data.full_name || \u0027\u0027).split(\u0027 \u0027).slice(1).join(\u0027 \u0027) || \u0027Lead\u0027 }}"
                                                                                   },
                                                                                   {
                                                                                       "name":  "phone",
                                                                                       "value":  "={{ $node[\"Normalize Agent JSON\"].json.data.phone || null }}"
                                                                                   },
                                                                                   {
                                                                                       "name":  "email",
                                                                                       "value":  "={{ $node[\"Normalize Agent JSON\"].json.data.email || null }}"
                                                                                   },
                                                                                   {
                                                                                       "name":  "company_name",
                                                                                       "value":  "={{ $node[\"Normalize Agent JSON\"].json.data.company_name || null }}"
                                                                                   },
                                                                                   {
                                                                                       "name":  "status",
                                                                                       "value":  "lead"
                                                                                   },
                                                                                   {
                                                                                       "name":  "source",
                                                                                       "value":  "telegram"
                                                                                   }
                                                                               ]
                                                            },
                                         "options":  {

                                                     }
                                     },
                      "type":  "n8n-nodes-base.httpRequest",
                      "typeVersion":  4.2,
                      "position":  [
                                       -13104,
                                       3840
                                   ],
                      "id":  "supa-create-lead-001",
                      "name":  "SUPA - Create Client (Lead)"
                  },
                  {
                      "parameters":  {
                                         "jsCode":  "let clientId = null;\nif (Array.isArray($json) \u0026\u0026 $json[0]?.id) clientId = $json[0].id;\nif (!clientId \u0026\u0026 $json?.id) clientId = $json.id;\nreturn [{ client_id: clientId }];"
                                     },
                      "type":  "n8n-nodes-base.code",
                      "typeVersion":  2,
                      "position":  [
                                       -12880,
                                       3744
                                   ],
                      "id":  "extract-lead-001",
                      "name":  "Extract client_id (Lead)"
                  },
                  {
                      "parameters":  {
                                         "method":  "POST",
                                         "url":  "={{ $env.SUPABASE_URL }}/rest/v1/chat_messages",
                                         "sendHeaders":  true,
                                         "headerParameters":  {
                                                                  "parameters":  [
                                                                                     {
                                                                                         "name":  "apikey",
                                                                                         "value":  "={{ $env.SUPABASE_SERVICE_ROLE_KEY }}"
                                                                                     },
                                                                                     {
                                                                                         "name":  "Authorization",
                                                                                         "value":  "={{ `Bearer ${$env.SUPABASE_SERVICE_ROLE_KEY}` }}"
                                                                                     },
                                                                                     {
                                                                                         "name":  "Content-Type",
                                                                                         "value":  "application/json"
                                                                                     }
                                                                                 ]
                                                              },
                                         "sendBody":  true,
                                         "bodyParameters":  {
                                                                "parameters":  [
                                                                                   {
                                                                                       "name":  "employee_id",
                                                                                       "value":  "={{ $env.DEFAULT_EMPLOYEE_ID }}"
                                                                                   },
                                                                                   {
                                                                                       "name":  "role",
                                                                                       "value":  "assistant"
                                                                                   },
                                                                                   {
                                                                                       "name":  "content",
                                                                                       "value":  "={{ $node[\"Normalize Agent JSON\"].json.data.content }}"
                                                                                   }
                                                                               ]
                                                            },
                                         "options":  {

                                                     }
                                     },
                      "type":  "n8n-nodes-base.httpRequest",
                      "typeVersion":  4.2,
                      "position":  [
                                       -13856,
                                       4208
                                   ],
                      "id":  "supa-add-msg-001",
                      "name":  "SUPA - Add Message"
                  },
                  {
                      "parameters":  {
                                         "url":  "={{ $env.SUPABASE_URL }}/rest/v1/clients?select=id,first_name,last_name,phone,email,status,created_at\u0026order=created_at.desc\u0026limit=10",
                                         "sendHeaders":  true,
                                         "headerParameters":  {
                                                                  "parameters":  [
                                                                                     {
                                                                                         "name":  "apikey",
                                                                                         "value":  "={{ $env.SUPABASE_SERVICE_ROLE_KEY }}"
                                                                                     },
                                                                                     {
                                                                                         "name":  "Authorization",
                                                                                         "value":  "={{ `Bearer ${$env.SUPABASE_SERVICE_ROLE_KEY}` }}"
                                                                                     },
                                                                                     {
                                                                                         "name":  "Accept",
                                                                                         "value":  "application/json"
                                                                                     }
                                                                                 ]
                                                              },
                                         "options":  {

                                                     }
                                     },
                      "type":  "n8n-nodes-base.httpRequest",
                      "typeVersion":  4.2,
                      "position":  [
                                       -13856,
                                       4480
                                   ],
                      "id":  "supa-list-001",
                      "name":  "SUPA - List Clients (Top10)"
                  },
                  {
                      "parameters":  {
                                         "jsCode":  "const rows = Array.isArray($json) ? $json : [];\nif (!rows.length) return [{ text: \u0027No hay leads/clientes todavÃ­a.\u0027 }];\nconst lines = rows.map((r, i) =\u003e {\n  const name = [r.first_name, r.last_name].filter(Boolean).join(\u0027 \u0027).trim() || \u0027Sin nombre\u0027;\n  const phone = r.phone ? `ðŸ“ž ${r.phone}` : \u0027\u0027;\n  const email = r.email ? `âœ‰ï¸ ${r.email}` : \u0027\u0027;\n  const status = r.status ? `(${r.status})` : \u0027\u0027;\n  return `${i+1}. ${name} ${status} ${phone} ${email}`.replace(/\\s+/g,\u0027 \u0027).trim();\n});\nreturn [{ text: \u0027Top 10 leads/clientes:\\n\\n\u0027 + lines.join(\u0027\\n\u0027) }];"
                                     },
                      "type":  "n8n-nodes-base.code",
                      "typeVersion":  2,
                      "position":  [
                                       -13600,
                                       4480
                                   ],
                      "id":  "format-list-001",
                      "name":  "Format Leads List"
                  },
                  {
                      "parameters":  {
                                         "jsCode":  "const d = $node[\u0027Normalize Agent JSON\u0027].json.data || {};\nconst phone = (d.phone || \u0027\u0027).trim();\nconst email = (d.email || \u0027\u0027).trim();\nif (!phone \u0026\u0026 !email) {\n  return [{ lookupUrl: null, phone, email }];\n}\nif (phone) {\n  return [{ lookupUrl: `${$env.SUPABASE_URL}/rest/v1/clients?select=id\u0026phone=eq.${encodeURIComponent(phone)}\u0026limit=1`, phone, email }];\n}\nreturn [{ lookupUrl: `${$env.SUPABASE_URL}/rest/v1/clients?select=id\u0026email=eq.${encodeURIComponent(email)}\u0026limit=1`, phone, email }];"
                                     },
                      "type":  "n8n-nodes-base.code",
                      "typeVersion":  2,
                      "position":  [
                                       -13856,
                                       3936
                                   ],
                      "id":  "lookup-appt-001",
                      "name":  "Build Client Lookup (Appt)"
                  },
                  {
                      "parameters":  {
                                         "url":  "={{ $json.lookupUrl }}",
                                         "sendHeaders":  true,
                                         "headerParameters":  {
                                                                  "parameters":  [
                                                                                     {
                                                                                         "name":  "apikey",
                                                                                         "value":  "={{ $env.SUPABASE_SERVICE_ROLE_KEY }}"
                                                                                     },
                                                                                     {
                                                                                         "name":  "Authorization",
                                                                                         "value":  "={{ `Bearer ${$env.SUPABASE_SERVICE_ROLE_KEY}` }}"
                                                                                     },
                                                                                     {
                                                                                         "name":  "Accept",
                                                                                         "value":  "application/json"
                                                                                     }
                                                                                 ]
                                                              },
                                         "options":  {

                                                     }
                                     },
                      "type":  "n8n-nodes-base.httpRequest",
                      "typeVersion":  4.2,
                      "position":  [
                                       -13600,
                                       3936
                                   ],
                      "id":  "supa-get-appt-001",
                      "name":  "SUPA - Get Client (Appt)"
                  },
                  {
                      "parameters":  {
                                         "conditions":  {
                                                            "boolean":  [
                                                                            {
                                                                                "value1":  "={{ Array.isArray($json) \u0026\u0026 $json.length \u003e 0 }}",
                                                                                "value2":  true
                                                                            }
                                                                        ]
                                                        },
                                         "options":  {

                                                     }
                                     },
                      "type":  "n8n-nodes-base.if",
                      "typeVersion":  2,
                      "position":  [
                                       -13360,
                                       3936
                                   ],
                      "id":  "if-appt-001",
                      "name":  "IF Client Exists (Appt)"
                  },
                  {
                      "parameters":  {
                                         "method":  "POST",
                                         "url":  "={{ $env.SUPABASE_URL }}/rest/v1/clients",
                                         "sendHeaders":  true,
                                         "headerParameters":  {
                                                                  "parameters":  [
                                                                                     {
                                                                                         "name":  "apikey",
                                                                                         "value":  "={{ $env.SUPABASE_SERVICE_ROLE_KEY }}"
                                                                                     },
                                                                                     {
                                                                                         "name":  "Authorization",
                                                                                         "value":  "={{ `Bearer ${$env.SUPABASE_SERVICE_ROLE_KEY}` }}"
                                                                                     },
                                                                                     {
                                                                                         "name":  "Content-Type",
                                                                                         "value":  "application/json"
                                                                                     },
                                                                                     {
                                                                                         "name":  "Prefer",
                                                                                         "value":  "return=representation"
                                                                                     }
                                                                                 ]
                                                              },
                                         "sendBody":  true,
                                         "bodyParameters":  {
                                                                "parameters":  [
                                                                                   {
                                                                                       "name":  "first_name",
                                                                                       "value":  "={{ ($node[\"Normalize Agent JSON\"].json.data.full_name || \u0027\u0027).split(\u0027 \u0027)[0] }}"
                                                                                   },
                                                                                   {
                                                                                       "name":  "last_name",
                                                                                       "value":  "={{ ($node[\"Normalize Agent JSON\"].json.data.full_name || \u0027\u0027).split(\u0027 \u0027).slice(1).join(\u0027 \u0027) || \u0027Lead\u0027 }}"
                                                                                   },
                                                                                   {
                                                                                       "name":  "phone",
                                                                                       "value":  "={{ $node[\"Normalize Agent JSON\"].json.data.phone || null }}"
                                                                                   },
                                                                                   {
                                                                                       "name":  "email",
                                                                                       "value":  "={{ $node[\"Normalize Agent JSON\"].json.data.email || null }}"
                                                                                   },
                                                                                   {
                                                                                       "name":  "status",
                                                                                       "value":  "lead"
                                                                                   },
                                                                                   {
                                                                                       "name":  "source",
                                                                                       "value":  "telegram"
                                                                                   }
                                                                               ]
                                                            },
                                         "options":  {

                                                     }
                                     },
                      "type":  "n8n-nodes-base.httpRequest",
                      "typeVersion":  4.2,
                      "position":  [
                                       -13120,
                                       4032
                                   ],
                      "id":  "supa-create-appt-client-001",
                      "name":  "SUPA - Create Client (Appt)"
                  },
                  {
                      "parameters":  {
                                         "jsCode":  "let clientId = null;\nif (Array.isArray($json) \u0026\u0026 $json[0]?.id) clientId = $json[0].id;\nif (!clientId \u0026\u0026 $json?.id) clientId = $json.id;\nreturn [{ client_id: clientId }];"
                                     },
                      "type":  "n8n-nodes-base.code",
                      "typeVersion":  2,
                      "position":  [
                                       -12880,
                                       3936
                                   ],
                      "id":  "extract-appt-001",
                      "name":  "Extract client_id (Appt)"
                  },
                  {
                      "parameters":  {
                                         "calendar":  {
                                                          "__rl":  true,
                                                          "value":  "primary",
                                                          "mode":  "list"
                                                      },
                                         "start":  "={{ $node[\"Normalize Agent JSON\"].json.data.start_time }}",
                                         "end":  "={{ $node[\"Normalize Agent JSON\"].json.data.end_time }}",
                                         "additionalFields":  {
                                                                  "description":  "={{ `Reservado vÃ­a Telegram | ${$node[\u0027Normalize Agent JSON\u0027].json.data.type || \u0027CITA\u0027}` }}",
                                                                  "summary":  "={{ $node[\"Normalize Agent JSON\"].json.data.title }}"
                                                              }
                                     },
                      "type":  "n8n-nodes-base.googleCalendar",
                      "typeVersion":  1.2,
                      "position":  [
                                       -12640,
                                       3936
                                   ],
                      "id":  "gcal-create-001",
                      "name":  "Google Calendar - Create Event",
                      "credentials":  {
                                          "googleCalendarOAuth2Api":  {
                                                                          "id":  "2aryGfWfAktg68Ly",
                                                                          "name":  "Google Calendar account"
                                                                      }
                                      }
                  },
                  {
                      "parameters":  {
                                         "method":  "POST",
                                         "url":  "={{ $env.SUPABASE_URL }}/rest/v1/appointments",
                                         "sendHeaders":  true,
                                         "headerParameters":  {
                                                                  "parameters":  [
                                                                                     {
                                                                                         "name":  "apikey",
                                                                                         "value":  "={{ $env.SUPABASE_SERVICE_ROLE_KEY }}"
                                                                                     },
                                                                                     {
                                                                                         "name":  "Authorization",
                                                                                         "value":  "={{ `Bearer ${$env.SUPABASE_SERVICE_ROLE_KEY}` }}"
                                                                                     },
                                                                                     {
                                                                                         "name":  "Content-Type",
                                                                                         "value":  "application/json"
                                                                                     }
                                                                                 ]
                                                              },
                                         "sendBody":  true,
                                         "bodyParameters":  {
                                                                "parameters":  [
                                                                                   {
                                                                                       "name":  "client_id",
                                                                                       "value":  "={{ $node[\u0027Extract client_id (Appt)\u0027].json.client_id }}"
                                                                                   },
                                                                                   {
                                                                                       "name":  "employee_id",
                                                                                       "value":  "={{ $env.DEFAULT_EMPLOYEE_ID }}"
                                                                                   },
                                                                                   {
                                                                                       "name":  "title",
                                                                                       "value":  "={{ $node[\u0027Normalize Agent JSON\u0027].json.data.title }}"
                                                                                   },
                                                                                   {
                                                                                       "name":  "type",
                                                                                       "value":  "={{ $node[\u0027Normalize Agent JSON\u0027].json.data.type || \u0027DEMO\u0027 }}"
                                                                                   },
                                                                                   {
                                                                                       "name":  "start_time",
                                                                                       "value":  "={{ $node[\u0027Normalize Agent JSON\u0027].json.data.start_time }}"
                                                                                   },
                                                                                   {
                                                                                       "name":  "end_time",
                                                                                       "value":  "={{ $node[\u0027Normalize Agent JSON\u0027].json.data.end_time }}"
                                                                                   },
                                                                                   {
                                                                                       "name":  "calendar_event_id",
                                                                                       "value":  "={{ $json.id }}"
                                                                                   }
                                                                               ]
                                                            },
                                         "options":  {

                                                     }
                                     },
                      "type":  "n8n-nodes-base.httpRequest",
                      "typeVersion":  4.2,
                      "position":  [
                                       -12400,
                                       3936
                                   ],
                      "id":  "supa-create-appt-001",
                      "name":  "SUPA - Create Appointment"
                  },
                  {
                      "parameters":  {
                                         "chatId":  "={{ $node[\u0027Map Telegram Input\u0027].json.chatId }}",
                                         "text":  "={{ $json.text || $node[\u0027Normalize Agent JSON\u0027].json.reply || \u0027Hecho.\u0027 }}",
                                         "additionalFields":  {

                                                              }
                                     },
                      "type":  "n8n-nodes-base.telegram",
                      "typeVersion":  1.2,
                      "position":  [
                                       -12048,
                                       4288
                                   ],
                      "id":  "telegram-send-001",
                      "name":  "Send to Telegram",
                      "credentials":  {
                                          "telegramApi":  {
                                                              "id":  "Wn2dsNr2SKUiwoAH",
                                                              "name":  "Sendia secretario"
                                                          }
                                      }
                  },
                  {
                      "parameters":  {
                                         "jsCode":  "const intent = $node[\u0027Normalize Agent JSON\u0027].json.intent;\nif ($node[\u0027Normalize Agent JSON\u0027].json.missing_fields?.length) {\n  return [{ text: $node[\u0027Normalize Agent JSON\u0027].json.reply || \u0027Me faltan datos para completar la acciÃ³n.\u0027 }];\n}\nif (intent === \u0027create_lead\u0027) return [{ text: \u0027âœ… Lead guardado en el CRM.\u0027 }];\nif (intent === \u0027add_note\u0027) return [{ text: \u0027âœ… Nota aÃ±adida.\u0027 }];\nif (intent === \u0027create_appointment\u0027) return [{ text: \u0027âœ… Cita creada en Google Calendar y guardada en el CRM.\u0027 }];\nif (intent === \u0027list_leads\u0027) return [{ text: $node[\u0027Format Leads List\u0027].json.text }];\nreturn [{ text: $node[\u0027Normalize Agent JSON\u0027].json.reply || \u0027Hecho.\u0027 }];"
                                     },
                      "type":  "n8n-nodes-base.code",
                      "typeVersion":  2,
                      "position":  [
                                       -12304,
                                       4288
                                   ],
                      "id":  "reply-001",
                      "name":  "Build Reply"
                  },
                  {
                      "parameters":  {
                                         "model":  {
                                                       "__rl":  true,
                                                       "mode":  "list",
                                                       "value":  "gpt-4o-mini"
                                                   },
                                         "options":  {

                                                     }
                                     },
                      "type":  "@n8n/n8n-nodes-langchain.lmChatOpenAi",
                      "typeVersion":  1.2,
                      "position":  [
                                       -14800,
                                       4160
                                   ],
                      "id":  "openai-model-001",
                      "name":  "OpenAI Model",
                      "credentials":  {
                                          "openAiApi":  {
                                                            "id":  "EjD1xFLPo07r54tp",
                                                            "name":  "OpenAi account"
                                                        }
                                      }
                  },
                  {
                      "parameters":  {
                                         "sessionIdType":  "customKey",
                                         "sessionKey":  "={{ $node[\"Map Telegram Input\"].json.chatId }}"
                                     },
                      "type":  "@n8n/n8n-nodes-langchain.memoryPostgresChat",
                      "typeVersion":  1.3,
                      "position":  [
                                       -14608,
                                       4160
                                   ],
                      "id":  "postgres-memory-001",
                      "name":  "Postgres Memory",
                      "credentials":  {
                                          "postgres":  {
                                                           "id":  "sq6JZvYpWDRXkqgF",
                                                           "name":  "Postgres account"
                                                       }
                                      }
                  }
              ],
    "connections":  {
                        "Telegram Trigger":  {
                                                 "main":  [
                                                              [
                                                                  {
                                                                      "node":  "Detect Audio/Text",
                                                                      "type":  "main",
                                                                      "index":  0
                                                                  }
                                                              ]
                                                          ]
                                             },
                        "Detect Audio/Text":  {
                                                  "main":  [
                                                               [
                                                                   {
                                                                       "node":  "Get Audio File",
                                                                       "type":  "main",
                                                                       "index":  0
                                                                   }
                                                               ],
                                                               [
                                                                   {
                                                                       "node":  "Map Telegram Input",
                                                                       "type":  "main",
                                                                       "index":  0
                                                                   }
                                                               ]
                                                           ]
                                              },
                        "Get Audio File":  {
                                               "main":  [
                                                            [
                                                                {
                                                                    "node":  "File to Binary",
                                                                    "type":  "main",
                                                                    "index":  0
                                                                }
                                                            ]
                                                        ]
                                           },
                        "File to Binary":  {
                                               "main":  [
                                                            [
                                                                {
                                                                    "node":  "Transcription",
                                                                    "type":  "main",
                                                                    "index":  0
                                                                }
                                                            ]
                                                        ]
                                           },
                        "Transcription":  {
                                              "main":  [
                                                           [
                                                               {
                                                                   "node":  "Map Telegram Input",
                                                                   "type":  "main",
                                                                   "index":  0
                                                               }
                                                           ]
                                                       ]
                                          },
                        "Map Telegram Input":  {
                                                   "main":  [
                                                                [
                                                                    {
                                                                        "node":  "AI Secretary Agent",
                                                                        "type":  "main",
                                                                        "index":  0
                                                                    }
                                                                ]
                                                            ]
                                               },
                        "AI Secretary Agent":  {
                                                   "main":  [
                                                                [
                                                                    {
                                                                        "node":  "Normalize Agent JSON",
                                                                        "type":  "main",
                                                                        "index":  0
                                                                    }
                                                                ]
                                                            ]
                                               },
                        "Normalize Agent JSON":  {
                                                     "main":  [
                                                                  [
                                                                      {
                                                                          "node":  "Route Intent",
                                                                          "type":  "main",
                                                                          "index":  0
                                                                      }
                                                                  ]
                                                              ]
                                                 },
                        "Route Intent":  {
                                             "main":  [
                                                          [
                                                              {
                                                                  "node":  "Build Client Lookup (Lead)",
                                                                  "type":  "main",
                                                                  "index":  0
                                                              }
                                                          ],
                                                          [
                                                              {
                                                                  "node":  "Build Client Lookup (Appt)",
                                                                  "type":  "main",
                                                                  "index":  0
                                                              }
                                                          ],
                                                          [
                                                              {
                                                                  "node":  "SUPA - Add Message",
                                                                  "type":  "main",
                                                                  "index":  0
                                                              }
                                                          ],
                                                          [
                                                              {
                                                                  "node":  "SUPA - List Clients (Top10)",
                                                                  "type":  "main",
                                                                  "index":  0
                                                              }
                                                          ],
                                                          [
                                                              {
                                                                  "node":  "Build Reply",
                                                                  "type":  "main",
                                                                  "index":  0
                                                              }
                                                          ]
                                                      ]
                                         },
                        "Build Client Lookup (Lead)":  {
                                                           "main":  [
                                                                        [
                                                                            {
                                                                                "node":  "SUPA - Get Client (Lead)",
                                                                                "type":  "main",
                                                                                "index":  0
                                                                            }
                                                                        ]
                                                                    ]
                                                       },
                        "SUPA - Get Client (Lead)":  {
                                                         "main":  [
                                                                      [
                                                                          {
                                                                              "node":  "IF Client Exists (Lead)",
                                                                              "type":  "main",
                                                                              "index":  0
                                                                          }
                                                                      ]
                                                                  ]
                                                     },
                        "IF Client Exists (Lead)":  {
                                                        "main":  [
                                                                     [
                                                                         {
                                                                             "node":  "Extract client_id (Lead)",
                                                                             "type":  "main",
                                                                             "index":  0
                                                                         }
                                                                     ],
                                                                     [
                                                                         {
                                                                             "node":  "SUPA - Create Client (Lead)",
                                                                             "type":  "main",
                                                                             "index":  0
                                                                         }
                                                                     ]
                                                                 ]
                                                    },
                        "SUPA - Create Client (Lead)":  {
                                                            "main":  [
                                                                         [
                                                                             {
                                                                                 "node":  "Extract client_id (Lead)",
                                                                                 "type":  "main",
                                                                                 "index":  0
                                                                             }
                                                                         ]
                                                                     ]
                                                        },
                        "Extract client_id (Lead)":  {
                                                         "main":  [
                                                                      [
                                                                          {
                                                                              "node":  "Build Reply",
                                                                              "type":  "main",
                                                                              "index":  0
                                                                          }
                                                                      ]
                                                                  ]
                                                     },
                        "SUPA - Add Message":  {
                                                   "main":  [
                                                                [
                                                                    {
                                                                        "node":  "Build Reply",
                                                                        "type":  "main",
                                                                        "index":  0
                                                                    }
                                                                ]
                                                            ]
                                               },
                        "SUPA - List Clients (Top10)":  {
                                                            "main":  [
                                                                         [
                                                                             {
                                                                                 "node":  "Format Leads List",
                                                                                 "type":  "main",
                                                                                 "index":  0
                                                                             }
                                                                         ]
                                                                     ]
                                                        },
                        "Format Leads List":  {
                                                  "main":  [
                                                               [
                                                                   {
                                                                       "node":  "Build Reply",
                                                                       "type":  "main",
                                                                       "index":  0
                                                                   }
                                                               ]
                                                           ]
                                              },
                        "Build Client Lookup (Appt)":  {
                                                           "main":  [
                                                                        [
                                                                            {
                                                                                "node":  "SUPA - Get Client (Appt)",
                                                                                "type":  "main",
                                                                                "index":  0
                                                                            }
                                                                        ]
                                                                    ]
                                                       },
                        "SUPA - Get Client (Appt)":  {
                                                         "main":  [
                                                                      [
                                                                          {
                                                                              "node":  "IF Client Exists (Appt)",
                                                                              "type":  "main",
                                                                              "index":  0
                                                                          }
                                                                      ]
                                                                  ]
                                                     },
                        "IF Client Exists (Appt)":  {
                                                        "main":  [
                                                                     [
                                                                         {
                                                                             "node":  "Extract client_id (Appt)",
                                                                             "type":  "main",
                                                                             "index":  0
                                                                         }
                                                                     ],
                                                                     [
                                                                         {
                                                                             "node":  "SUPA - Create Client (Appt)",
                                                                             "type":  "main",
                                                                             "index":  0
                                                                         }
                                                                     ]
                                                                 ]
                                                    },
                        "SUPA - Create Client (Appt)":  {
                                                            "main":  [
                                                                         [
                                                                             {
                                                                                 "node":  "Extract client_id (Appt)",
                                                                                 "type":  "main",
                                                                                 "index":  0
                                                                             }
                                                                         ]
                                                                     ]
                                                        },
                        "Extract client_id (Appt)":  {
                                                         "main":  [
                                                                      [
                                                                          {
                                                                              "node":  "Google Calendar - Create Event",
                                                                              "type":  "main",
                                                                              "index":  0
                                                                          }
                                                                      ]
                                                                  ]
                                                     },
                        "Google Calendar - Create Event":  {
                                                               "main":  [
                                                                            [
                                                                                {
                                                                                    "node":  "SUPA - Create Appointment",
                                                                                    "type":  "main",
                                                                                    "index":  0
                                                                                }
                                                                            ]
                                                                        ]
                                                           },
                        "SUPA - Create Appointment":  {
                                                          "main":  [
                                                                       [
                                                                           {
                                                                               "node":  "Build Reply",
                                                                               "type":  "main",
                                                                               "index":  0
                                                                           }
                                                                       ]
                                                                   ]
                                                      },
                        "Build Reply":  {
                                            "main":  [
                                                         [
                                                             {
                                                                 "node":  "Send to Telegram",
                                                                 "type":  "main",
                                                                 "index":  0
                                                             }
                                                         ]
                                                     ]
                                        },
                        "OpenAI Model":  {
                                             "ai_languageModel":  [
                                                                      [
                                                                          {
                                                                              "node":  "AI Secretary Agent",
                                                                              "type":  "ai_languageModel",
                                                                              "index":  0
                                                                          }
                                                                      ]
                                                                  ]
                                         },
                        "Postgres Memory":  {
                                                "ai_memory":  [
                                                                  [
                                                                      {
                                                                          "node":  "AI Secretary Agent",
                                                                          "type":  "ai_memory",
                                                                          "index":  0
                                                                      }
                                                                  ]
                                                              ]
                                            }
                    },
    "active":  true,
    "settings":  {
                     "executionOrder":  "v1"
                 }
}
